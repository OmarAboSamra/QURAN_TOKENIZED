name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-format:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy
        pip install -r requirements.txt
    
    - name: Run Black (code formatting)
      run: black --check backend/ scripts/ tests/
    
    - name: Run isort (import sorting)
      run: isort --check-only backend/ scripts/ tests/
    
    - name: Run Flake8 (linting)
      run: |
        flake8 backend/ scripts/ tests/ \
          --max-line-length=100 \
          --ignore=E203,W503,E501 \
          --exclude=.venv,__pycache__,.git
    
    - name: Run mypy (type checking)
      run: |
        mypy backend/ \
          --ignore-missing-imports \
          --no-strict-optional \
          --warn-return-any \
          --warn-unused-configs
      continue-on-error: true

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: quran_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: quran_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests with coverage
      env:
        DATABASE_URL: postgresql+asyncpg://quran_test:test_password@localhost:5432/quran_test_db
        REDIS_URL: redis://localhost:6379/0
        CACHE_ENABLED: true
        ENVIRONMENT: test
      run: |
        pytest tests/ \
          --cov=backend \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          -v
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      if: github.event_name == 'push'

  build:
    name: Build and Verify
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify imports
      run: |
        python -c "from backend.main import app; print('✓ Application imports successfully')"
    
    - name: Check database models
      run: |
        python -c "from backend.models.token_model import Token; from backend.models.root_model import Root; print('✓ Models valid')"
    
    - name: Generate migration check
      run: |
        echo "✓ Build verification complete"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Bandit security linter
      uses: jpetrucciani/bandit-check@main
      with:
        path: 'backend/'
        
    - name: Run Safety check
      run: |
        pip install safety
        safety check --json || true
      continue-on-error: true
